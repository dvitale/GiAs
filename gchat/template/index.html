<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link rel="stylesheet" href="{{.basePath}}/static/css/style.css">
    <link rel="stylesheet" href="{{.basePath}}/static/css/new-formatting.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="app-container" id="appContainer">
        <!-- Header con dati utente -->
        <header class="app-header" id="appHeader">
            <div class="header-left">
                <img src="{{.basePath}}/static/img/gias.png" alt="GIAS" class="header-logo" id="giasLogo"
                    title="Ctrl+Click: debug | Shift+Click: langgraph">
            </div>
            <div class="header-center">
                {{if .user}}
                <div class="user-info">
                    <span class="user-name">{{.user.namefirst}} {{.user.namelast}}</span>
                    {{if .user.asl}}<span class="user-asl">ASL {{.user.asl}}</span>{{end}}
                    {{if .user.hierarchy}}
                    <div class="user-hierarchy">{{.user.hierarchy}}</div>
                    {{end}}
                </div>
                {{else}}
                <span class="header-title">{{.title}}</span>
                {{end}}
            </div>
            <div class="header-right">
                <a id="historyLink" class="header-nav-link" title="Cronologia">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </a>
                <button class="theme-toggle" id="themeToggle" aria-label="Cambia tema">
                    <svg class="theme-icon sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="theme-icon moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <img src="{{.basePath}}/static/img/logo-reg.png" alt="Regione Campania" class="header-logo">
            </div>
        </header>

        <!-- Welcome Screen (stato iniziale) -->
        <div class="welcome-screen" id="welcomeScreen">
            <div class="welcome-content">
                <!-- Greeting -->
                <div class="greeting-section">
                    <div class="greeting-icon">
                        <img src="{{.basePath}}/static/img/l.png" alt="Logo" width="32" height="32">
                    </div>
                    <h1 class="greeting-text" id="greetingText">Ciao</h1>
                </div>

                <!-- Input Area -->
                <div class="welcome-input-wrapper">
                    <div class="welcome-input-container">
                        <textarea
                            id="messageInput"
                            class="welcome-textarea"
                            placeholder="Come posso aiutarti oggi?"
                            rows="1"
                            autocomplete="off"
                        ></textarea>
                        <button id="sendButton" class="send-button" disabled aria-label="Invia messaggio">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Quick Actions (Predefined Questions) -->
                <div class="quick-actions" id="quickActions">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Chat Screen (stato chat) -->
        <div class="chat-screen hidden" id="chatScreen">
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here -->
            </div>

            <div class="chat-input-area">
                <div class="chat-quick-actions" id="chatQuickActions">
                    <!-- Quick actions moved here from welcome screen -->
                </div>
                <div class="chat-input-container">
                    <textarea
                        id="chatMessageInput"
                        class="chat-textarea"
                        placeholder="Scrivi un messaggio..."
                        rows="1"
                        autocomplete="off"
                    ></textarea>
                    <button id="chatSendButton" class="send-button" disabled aria-label="Invia messaggio">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <div></div>
                <div></div>
                <div></div>
            </div>
            <span>Sto elaborando...</span>
        </div>
    </div>

    <script>
        // Base path for API calls
        window.basePath = "{{.basePath}}";

        // Transcription feature flag
        window.transcriptionEnabled = {{.transcriptionEnabled}};

        // Streaming feature flag
        window.streamingEnabled = {{.streamingEnabled}};

        // Welcome message and user data
        window.welcomeData = {
            message: JSON.parse({{.welcomeMessage | printf "%q"}}),
            userName: {{if .user}}{{.user.namefirst | json}}{{else}}null{{end}},
            userLastName: {{if .user}}{{.user.namelast | json}}{{else}}null{{end}},
            userASL: {{if .user}}{{.user.asl | json}}{{else}}null{{end}}
        };

        // Pass query parameters to JavaScript
        window.queryParams = {
            asl_id: {{if .queryParams.asl_id}}{{.queryParams.asl_id | json}}{{else}}null{{end}},
            asl_name: {{if .queryParams.asl_name}}{{.queryParams.asl_name | json}}{{else}}null{{end}},
            user_id: {{if .queryParams.user_id}}{{.queryParams.user_id | json}}{{else}}null{{end}},
            codice_fiscale: {{if .queryParams.codice_fiscale}}{{.queryParams.codice_fiscale | json}}{{else}}null{{end}},
            username: {{if .queryParams.username}}{{.queryParams.username | json}}{{else}}null{{end}}
        };

        // Build history link with current params
        (function() {
            var p = window.queryParams;
            var bp = window.basePath || '';
            var qs = [];
            if (p.user_id) qs.push('user_id=' + encodeURIComponent(p.user_id));
            if (p.asl_id) qs.push('asl_id=' + encodeURIComponent(p.asl_id));
            if (p.asl_name) qs.push('asl_name=' + encodeURIComponent(p.asl_name));
            if (p.codice_fiscale) qs.push('codice_fiscale=' + encodeURIComponent(p.codice_fiscale));
            if (p.username) qs.push('username=' + encodeURIComponent(p.username));
            var link = document.getElementById('historyLink');
            if (link) link.href = bp + '/history' + (qs.length ? '?' + qs.join('&') : '');
        })();
    </script>
    <script src="{{.basePath}}/static/js/chat.js?v=5"></script>
</body>

</html>
